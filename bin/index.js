(()=>{"use strict";var e={n(t){var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d(t,r){for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{default:()=>ue});const r=require("@babel/runtime/helpers/asyncToGenerator");var n=e.n(r);const o=require("@babel/runtime/helpers/defineProperty");var s=e.n(o);const c=require("assert");var i=e.n(c);const a=require("events");var u=new a.EventEmitter({captureRejections:!0}),l=new a.EventEmitter({captureRejections:!0});["SIGINT","SIGTERM","SIGUSR2","exit"].forEach((e=>l.once(e,(()=>u.emit("processKill",e)))));class p{constructor(){s()(this,"once",(function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return(0,a.once)(u,...t)}))}emit(){return u.emit(...arguments),this}on(){return u.on(...arguments),this}off(){return u.off(...arguments),this}}var{MQ_HOSTNAME:h,MQ_PASSWORD:f,MQ_PORT:m,MQ_USERNAME:y}=process.env;const d={env:"production",semVer:"0.0.0",mq:{connectionCheckDelay:1e3,hostname:h,password:f,port:m,username:y}},v=require("amqplib");var b=e.n(v);const O=require("rabbitmq-stream-js-client");function g(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function w(e){for(var t,r=1;r<arguments.length;r++)t=null==arguments[r]?{}:arguments[r],r%2?g(Object(t),!0).forEach((function(r){s()(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):g(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}));return e}function j(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function S(e){for(var t,r=1;r<arguments.length;r++)t=null==arguments[r]?{}:arguments[r],r%2?j(Object(t),!0).forEach((function(r){s()(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):j(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}));return e}function P(e,t,r){T(e,t),t.set(e,r)}function T(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function E(e,t){return e.get(A(e,t))}function R(e,t,r){return e.set(A(e,t),r),r}function A(e,t,r){if("function"==typeof e?e===t:e.has(t))return 3>arguments.length?t:r;throw new TypeError("Private element is not present on this object")}var k=1e3,q={hostname:null,password:null,port:null,username:null},M=new WeakMap,D=new WeakMap,C=new WeakMap,N=new WeakMap,V=new WeakSet;class W extends p{static configure(e){q=((e,t)=>w(w(w({},t),e),Object.entries(t).reduce(((t,r)=>{var[n,o]=r;return w(w({},t),{},{[n]:e[n]&&e[n]instanceof Object&&!(e[n]instanceof Array)?w(w({},e[n]),o):o})}),{})))(q,e)}constructor(){var e;super(),T(this,e=V),e.add(this),P(this,M,void 0),P(this,D,!1),P(this,C,void 0),P(this,N,!1)}static queueConnection(){return n()((function*(){var e=new W;return E(D,e)||(yield A(V,e,_).call(e)),E(M,e)}))()}static streamConnection(){return n()((function*(){var e=new W;return E(N,e)||(yield A(V,e,I).call(e)),E(C,e)}))()}}function _(){return x.apply(this,arguments)}function x(){return(x=n()((function*(){var e=this;try{R(M,this,yield b().connect(S(S({},q),{},{protocol:"amqp",heartbeat:60})))}catch(e){console.error(e)}E(M,this).on("error",(e=>"Connection closing"===e.message?null:conn.emit("AMQP:error",e))),E(M,this).on("close",(()=>setTimeout((()=>process.nextTick(n()((function*(){return yield A(V,e,_).call(e)})))),k)))}))).apply(this,arguments)}function I(){return Q.apply(this,arguments)}function Q(){return Q=n()((function*(){var e,t,r=arguments,o=this;try{R(C,this,yield O.connect(S(S({},q),{},{host:q.hostname,port:5552,vhost:"/",addressResolver:{enabled:!0},listeners:{oncomplete:(t=n()((function*(){console.log("complete args:",r)})),function(){return t.apply(this,arguments)}),connection_closed:(e=n()((function*(){console.log("connection_closed args:",r),console.info("In connection closed event...");try{yield E(C,o).restart(),console.log("restarted stream connection to rabbit")}catch(e){console.error("Could not reconnect to Rabbit!",e)}})),function(){return e.apply(this,arguments)})}})))}catch(e){console.error(e)}})),Q.apply(this,arguments)}const G=require("@donsky/node-avro");function J(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function U(e){for(var t,r=1;r<arguments.length;r++)t=null==arguments[r]?{}:arguments[r],r%2?J(Object(t),!0).forEach((function(r){s()(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):J(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}));return e}class z extends TypeError{constructor(e){var{message:t,statusCode:r,statusMessage:n}=e;super(t),this.name=this.constructor.name,this.statusCode=r,this.statusMessage=n,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=Error(t).stack}}class K{constructor(e,t){var r=this;return s()(this,"connection",void 0),s()(this,"stream",void 0),s()(this,"publisher",void 0),this.connection=e,this.stream=t,this instanceof K?n()((function*(){try{yield r.connection.createStream({stream:r.stream,arguments:{"max-length-bytes":5e9}})}catch(e){if(!e.message.includes("code 17"))throw e}try{r.publisher=yield r.connection.declarePublisher({stream:r.stream,publisherRef:"publisherRef-".concat((new Date).getTime())}),r.publisher.on("error",(e=>console.error(e)))}catch(e){throw console.error(e),e}return r}))():new K(e,t)}on(e,t){this.publisher.on(e,t)}send(e){this.publisher.send(e)}close(){return this.publisher.close()}}class B{constructor(e,t,r){var o=this;return s()(this,"config",void 0),s()(this,"connection",void 0),s()(this,"consumer",void 0),this.connection=e,this.config=t,this instanceof B?n()((function*(){if(null===!r)throw Error("No message processor declared");try{yield o.connection.createStream({stream:o.config.stream,arguments:{"max-length-bytes":5e9}})}catch(e){if(console.log("ERRRRR:",e),17!==e.code)throw err}return console.log("attach consumer",o.config),o.consumer=yield o.connection.declareConsumer(o.config,r),o}))():new B(e,t,r)}on(e,t){this.consumer.on(e,t)}close(){var e=this;return n()((function*(){return yield e.consumer.close()}))()}}var F=(e,t)=>{switch(!1){case e.version===t.version:throw"compareServiceAction: [version] mismatch.";case e.action===t.action:throw"compareServiceAction: [action] mismatch.";case e.method===t.method:throw"compareServiceAction: [method] mismatch.";case e.topic===t.topic:throw"compareServiceAction: [topic] mismatch.";case e.route===t.route:throw"compareServiceAction: [route] mismatch.";case e.requestTransformers===t.requestTransformers:throw"compareServiceAction: [requestTransformers] mismatch.";case e.responseTransformers===t.responseTransformers:throw"compareServiceAction: [responseTransformers] mismatch.";case e.requestAVRO===t.requestAVRO:throw"compareServiceAction: [requestAVRO] mismatch.";case e.responseAVRO===t.responseAVRO:throw"compareServiceAction: [responseAVRO] mismatch."}};function H(e,t,r){$(e,t),t.set(e,r)}function $(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function L(e,t){return e.get(Y(e,t))}function X(e,t,r){return e.set(Y(e,t),r),r}function Y(e,t,r){if("function"==typeof e?e===t:e.has(t))return 3>arguments.length?t:r;throw new TypeError("Private element is not present on this object")}function Z(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function ee(e){for(var t,r=1;r<arguments.length;r++)t=null==arguments[r]?{}:arguments[r],r%2?Z(Object(t),!0).forEach((function(r){s()(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Z(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}));return e}var te=ee({},d),re=Symbol("Service-ActiveNames"),ne=Symbol("Service-NamedVersions"),oe=(Symbol("ServiceName-Toggle"),new WeakMap),se=new WeakMap,ce=new WeakMap,ie=new WeakMap,ae=new WeakSet;class ue extends p{static configure(e){te=((e,t)=>U(U(U({},t),e),Object.entries(t).reduce(((t,r)=>{var[n,o]=r;return U(U({},t),{},{[n]:e[n]&&e[n]instanceof Object&&!(e[n]instanceof Array)?U(U({},e[n]),o):o})}),{})))(te,e)}constructor(e){var t,r;return super(),t=this,$(this,r=ae),r.add(this),H(this,oe,void 0),H(this,se,void 0),H(this,ce,void 0),H(this,ie,void 0),X(oe,this,ee({},Object.entries(e).reduce(((e,t)=>{var[r,n]=t;return e[r]=ee(ee({},n),{},{requestTransformers:n.requestTransformers.map((e=>e.toString())),responseTransformers:n.responseTransformers.map((e=>e.toString()))}),e}),{}))),this instanceof ue?n()((function*(){return X(oe,t,ee({},Object.entries(e).reduce(((e,t)=>{var[r,n]=t;return e[r]=ee(ee({},n),{},{requestTransformers:n.requestTransformers.map((e=>e.toString())),responseTransformers:n.responseTransformers.map((e=>e.toString()))}),e}),{}))),yield Y(ae,t,pe).call(t),t.on("processKill",(()=>Y(ae,t,le).call(t))),t}))():new ue(e)}}function le(){var e,t;console.log("Destruction of Service: ${config.topic}"),null===(e=L(se,this))||void 0===e||e.close(),null===(t=L(ie,this))||void 0===t||t.close()}function pe(){return he.apply(this,arguments)}function he(){return(he=n()((function*(){W.configure(te.mq),X(se,this,yield W.queueConnection()),X(ie,this,yield W.streamConnection()),L(se,this).on("error",(e=>{this.emit("error",e)})),yield Y(ae,this,fe).call(this),yield Y(ae,this,ye).call(this)}))).apply(this,arguments)}function fe(){return me.apply(this,arguments)}function me(){return me=n()((function*(){var e=this;if({}==!L(oe,this))throw new z({message:"No valid actions. This service won't be discoverable by the gateway automatically and is basically useless anyways. Why did you start the service without any actions?",statusCode:404,statusMessage:"actions: ".concat(JSON.parse(L(oe,this)))});if(!te.topic)throw new z({message:"No valid topic[hostname]. This service won't be discoverable by the gateway automatically",statusCode:404,statusMessage:"config.mq.hostname: ".concat(te.topic)});var t=function(){var t=n()((function*(t,r){var o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[],s=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},c=[];try{for(var a of(yield new Promise(function(){var o=n()((function*(o,i){try{var a="my-consumer-ref-".concat((new Date).getTime()),u={stream:t,offset:r,consumerRef:a};s&&"{}"!==JSON.stringify(s)&&(u.filter=s);var l,p=yield new B(L(ie,e),u,function(){var e=n()((function*(e){var t,r;clearTimeout(l),l=setTimeout((()=>{clearTimeout(l),p.close(),console.log("resolve after message"),o()}),500),r=e.content.toString(),t=JSON.parse(r),c.push(t)}));return function(){return e.apply(this,arguments)}}());l=setTimeout((()=>{clearTimeout(l),p.close(),console.log("resolve with no message"),o()}),1e3)}catch(e){console.error(e),i(e)}}));return function(){return o.apply(this,arguments)}}()),o)){var u=!1;for(var l of c)try{if("string"==typeof l){i().deepEqual(a,l),u=!0;break}if("object"==typeof l){F(a,l),u=!0;break}}catch(e){console.log("catch error",e);continue}if(!u){var p,h,f=yield new K(L(ie,e),t);yield f.send((h=a,p=JSON.stringify(h),Buffer.from(p)),{topic:te.topic}),yield f.close()}}}catch(e){throw console.log("StreamProcessor ERROR: ",e),e}}));return function(){return t.apply(this,arguments)}}();try{yield t(re.description,O.Offset.first(),[te.topic]),yield t(ne.description,O.Offset.first(),["".concat(te.topic,"-").concat(te.semVer)]),yield t("Service-".concat(te.topic,"-").concat(te.semVer,"-Actions"),O.Offset.first(),Object.entries(L(oe,this)).map((e=>{var[t,r]=e;return r})))}catch(e){console.error(e)}this.emit("actionsRegistered",L(oe,this))})),me.apply(this,arguments)}function ye(){return de.apply(this,arguments)}function de(){return de=n()((function*(){var e=this;try{X(ce,this,yield L(se,this).createChannel()),L(ce,this).assertQueue(te.topic,{durable:!0}),L(ce,this).prefetch(1),L(ce,this).consume(te.topic,function(){var t=n()((function*(t){var{properties:{type:r,correlationId:n,replyTo:o},content:s}=t;if(!L(oe,e)[r])throw new TypeError("No Function '".concat(r,"' on 'this'"));try{var{data:c}=(0,G.fromAVRO)(s,L(oe,e)[r].requestAVRO),i=yield L(oe,e)[r].lambda.call(e,c);L(ce,e).sendToQueue(o,yield(0,G.toAVRO)({response:i},L(oe,e)[r].responseAVRO,{response:!0}),{type:"".concat(r,"Response"),correlationId:n})}catch(t){var{name:a,message:u,status:l,stack:p,userError:h}=t;try{L(ce,e).sendToQueue(o,yield(0,G.toAVRO)({error:{name:a||"PrepareService::channel:consume",message:u||"Unknown Error",stack:p||"None",status:l||500,userError:!!h&&h}},{},{error:!0}),{type:"ErrorResponse",correlationId:n}),e.emit("error",t)}catch(t){e.emit("error",t)}}}));return function(){return t.apply(this,arguments)}}(),{noAck:!0})}catch(e){this.emit("error",e)}finally{this.emit("ready",te.topic)}})),de.apply(this,arguments)}module.exports=t})();
//# sourceMappingURL=index.js.map